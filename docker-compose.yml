networks:
  dataengine-network:
    name: dataengine-network

services:
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "8080:80"
    volumes:
      - ./example/nginx/html:/usr/share/nginx/html
      - ./example/nginx/default.conf.template:/etc/nginx/templates/default.conf.template
    restart: always
    depends_on:
      aas-template-registry:
        condition: service_healthy
      sm-template-regisry:
        condition: service_healthy
      template-repository:
        condition: service_healthy
    networks:
      - dataengine-network

  twinengine-dataengine:
    build:
      context: ./source
      dockerfile: ./AAS.TwinEngine.DataEngine/Dockerfile
    image: twinengine-dataengine:latest
    ports:
    - '8085:8080'
    container_name: twinengine-dataengine
    depends_on:
      - mongo
    restart: always
    environment:
      - AasEnvironment__DataEngineRepositoryBaseUrl=http://localhost:8080
      - AasEnvironment__AasEnvironmentRepositoryBaseUrl=http://template-repository:8081
      - AasEnvironment__SubModelRepositoryPath=submodels
      - AasEnvironment__AasRegistryBaseUrl=http://aas-template-registry:8080
      - AasEnvironment__AasRegistryPath=shell-descriptors
      - AasEnvironment__SubModelRegistryBaseUrl=http://sm-template-regisry:8080
      - AasEnvironment__SubModelRegistryPath=submodel-descriptors
      - AasEnvironment__AasRepositoryPath=shells
      - AasEnvironment__SubmodelRefPath=submodel-refs
      - AasEnvironment__CustomerDomainUrl=https://mm-software.com
      - TemplateMappingRules__SubmodelTemplateMappings__0__templateId=https://admin-shell.io/idta/SubmodelTemplate/Reliability/1/0
      - TemplateMappingRules__SubmodelTemplateMappings__0__pattern__0=Reliability
      - TemplateMappingRules__SubmodelTemplateMappings__1__templateId=https://admin-shell.io/idta/SubmodelTemplate/DigitalNameplate/3/0
      - TemplateMappingRules__SubmodelTemplateMappings__1__pattern__0=Nameplate
      - TemplateMappingRules__SubmodelTemplateMappings__2__templateId=https://admin-shell.io/idta/SubmodelTemplate/ContactInformation/1/0
      - TemplateMappingRules__SubmodelTemplateMappings__2__pattern__0=ContactInformation
      - TemplateMappingRules__ShellTemplateMappings__0__templateId=https://mm-software.com/aas/aasTemplate
      - TemplateMappingRules__ShellTemplateMappings__0__pattern__0=
      - TemplateMappingRules__AasIdExtractionRules__0__pattern=Regex
      - TemplateMappingRules__AasIdExtractionRules__0__index=6
      - TemplateMappingRules__AasIdExtractionRules__0__separator=/
      - Semantics__MultiLanguageSemanticPostfixSeparator=_
      - Semantics__SubmodelElementIndexContextPrefix=_aastwinengineindex_
      - Semantics__InternalSemanticId=InternalSemanticId
      - AasxOptions__RootFolder=aasx
      - AasRegistryTimeTrigger__ShellDescriptorCron=0 */3 * * * *
      - AasRegistryTimeTrigger__IsPreComputed=false
      - MultiPluginConflictOption__HandlingMode=TakeFirst
      - PluginConfig__Plugins__0__PluginName=Plugin1
      - PluginConfig__Plugins__0__PluginUrl=http://twinengine-plugin1:8080
      - PluginConfig__Plugins__1__PluginName=Plugin2
      - PluginConfig__Plugins__1__PluginUrl=http://twinengine-plugin2:8080
    networks:
      - dataengine-network

  twinengine-plugin1:
    build:
      context: ../AasTwin.Plugin/source
      dockerfile: ./Aas.TwinEngine.Plugin.ReferencePlugin/Dockerfile
    image: twinengine-plugin:latest
    ports:
    - '8086:8080'
    container_name: twinengine-plugin1
    restart: always
    volumes:
      - ./example/plugin1/mock-metadata.json:/app/Data/mock-metadata.json
      - ./example/plugin1/mock-submodel-data.json:/app/Data/mock-submodel-data.json
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Semantics__IndexContextPrefix=_aastwinengineindex_
      - Capabilities__HasShellDescriptor=true
      - Capabilities__HasAssetInformation=true
    networks:
      - dataengine-network

  twinengine-plugin2:
    image: twinengine-plugin:latest
    container_name: twinengine-plugin2
    ports:
    - '8087:8080'
    restart: always
    volumes:
      - ./example/plugin2/mock-metadata.json:/app/Data/mock-metadata.json:ro
      - ./example/plugin2/mock-submodel-data.json:/app/Data/mock-submodel-data.json
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Semantics__IndexContextPrefix=_aastwinengineindex_
      - Capabilities__HasShellDescriptor=true
      - Capabilities__HasAssetInformation=true
    networks:
      - dataengine-network

  template-repository:
    image: eclipsebasyx/aas-environment:2.0.0-SNAPSHOT
    container_name: template-repository
    ports:
      - "8081:8081"
    volumes:
      - ./example/aas:/application/aas
      - ./example/basyx/aas-env.properties:/application/application.properties
    environment:
      BASYX_EXTERNALURL : http://localhost:8080
    restart: always
    depends_on:
      aas-template-registry:
        condition: service_healthy
      sm-template-regisry:
        condition: service_healthy
    networks:
      - dataengine-network

  aas-template-registry:
    image: eclipsebasyx/aas-registry-log-mongodb:2.0.0-SNAPSHOT
    container_name: aas-template-registry
    ports:
      - '8082:8080'
    restart: always
    depends_on:
      - mongo
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongoAdmin:mongoPassword@mongo:27017
    networks:
      - dataengine-network

  sm-template-regisry:
    image: eclipsebasyx/submodel-registry-log-mongodb:2.0.0-SNAPSHOT
    container_name: sm-template-regisry
    ports:
      - '8083:8080'
    depends_on:
      - mongo
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongoAdmin:mongoPassword@mongo:27017
    networks:
      - dataengine-network

  shell-template-creator:
    image: curlimages/curl:latest
    container_name: shell-template-creator
    depends_on:
      template-repository:
        condition: service_healthy
    entrypoint: >
      sh -c '
        echo "Waiting for template-repository to be ready...";
        sleep 10;
        curl -X POST http://template-repository:8081/shells \
          -H "accept: application/json" \
          -H "Content-Type: application/json" \
          -d "{\"id\": \"https://mm-software.com/aas/aasTemplate\", \"assetInformation\": {\"assetKind\": \"Instance\"}, \"submodels\": [{\"type\": \"ModelReference\", \"keys\": [{\"type\": \"Submodel\", \"value\": \"Nameplate\"}]}, {\"type\": \"ModelReference\", \"keys\": [{\"type\": \"Submodel\", \"value\": \"ContactInformation\"}]}, {\"type\": \"ModelReference\", \"keys\": [{\"type\": \"Submodel\", \"value\": \"Reliability\"}]}], \"modelType\": \"AssetAdministrationShell\"}";
        echo "Shell creation request sent.";
      '
    networks:
      - dataengine-network

  aas-web-ui:
    image: eclipsebasyx/aas-gui:SNAPSHOT
    container_name: aas-ui
    volumes:
      - ./example/logo:/usr/src/app/dist/Logo
    environment:
      AAS_REGISTRY_PATH: http://localhost:8080/shell-descriptors
      SUBMODEL_REGISTRY_PATH: http://localhost:8080/submodel-descriptors
      AAS_REPO_PATH: http://localhost:8080/shells
      SUBMODEL_REPO_PATH: http://localhost:8080/submodels
      CD_REPO_PATH: http://localhost:8080/concept-descriptions
      BASE_PATH: "/aas-ui"
      LOGO_PATH: "MM_Logo.svg"
      PRIMARY_DARK_COLOR: "#EBECED"
      PRIMARY_LIGHT_COLOR: "#00F2E5"
    restart: always
    depends_on:
      template-repository:
        condition: service_healthy
    networks:
      - dataengine-network

  mongo:
    image: mongo:6.0
    container_name: mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: mongoAdmin
      MONGO_INITDB_ROOT_PASSWORD: mongoPassword
    networks:
      - dataengine-network

